import{Ha as A,Ia as F,R as I,ba as B,d as _,m as j,p as v,q as D,r as x}from"./chunk-PQWATTJB.js";import{h as f,n as d}from"./chunk-YJSZZTEX.js";f();d();f();d();function U(e){let n=0;for(let i of e)i.stackId!==void 0&&n++;return n}f();d();var T=new Map,g=!1;function G(){g=performance.now()}function V(){g=!1,T.clear()}function J(e,n){T.set(n,e)}function k(e){if(!(g===!1||e.startTime<g))return T.get(e.startTime)}function z(e){if(!(g===!1||e<g))for(let n of T.keys())n<e&&T.delete(n)}f();d();function C({rawRumEvent:e,startTime:n}){if(e.type!=="long_task")return;let i=e.long_task.id;J(i,n)}f();d();var se=(e,n,i,r)=>{let m=ie(e,n,i,r),c=le(e,m),l=n.build("fetch",c);return B("Sending profile to public profiling intake",{profilingIntakeURL:l,applicationId:i,sessionId:r}),fetch(l,{body:c.data,method:"POST"})};function ie(e,n,i,r){let m=n.tags,c=ce(e,i,r),l=ae(m),s=new Date(e.timeOrigin+e.startTime),y=new Date(e.timeOrigin+e.endTime);return{...c,attachments:["wall-time.json"],start:s.toISOString(),end:y.toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:l.join(",")}}function ae(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function le(e,n){let i=new Blob([JSON.stringify(e)],{type:"application/json"}),r=new FormData;return r.append("event",new Blob([JSON.stringify(n)],{type:"application/json"}),"event.json"),r.append("wall-time.json",i,"wall-time.json"),{data:r,bytesCount:0}}function ce(e,n,i){let r={application:{id:n}};i&&(r.session={id:i});let m=Array.from(new Set(e.views.map(l=>l.viewId)));m.length&&(r.view={id:m});let c=e.longTasks.map(l=>k(l)).filter(l=>l!==void 0);return c.length&&(r.long_task={id:c}),r}var H={sendProfile:se};var ue={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function _e(e,n,i,r=ue){let m=F(A.LONG_ANIMATION_FRAME),c,l=[],s={state:"stopped"};function y(t){s.state!=="running"&&(c=t?{startTime:t.startClocks.relative,viewId:t.id,viewName:t.name}:void 0,l.push(I(e,self,"visibilitychange",W).stop,I(e,self,"beforeunload",X).stop),b())}async function P(){await S("stopped"),V(),l.forEach(t=>t())}function q(t){if(t.state==="running")return{cleanupTasks:t.cleanupTasks,observer:t.observer};let o=[],a;if(e.trackLongTasks){a=new PerformanceObserver(Q),a.observe({entryTypes:[Y()]});let u=n.subscribe(12,w=>{C(w)});G(),o.push(()=>a?.disconnect()),o.push(u.unsubscribe)}let p=n.subscribe(2,u=>{E({viewId:u.id,viewName:u.name,startTime:u.startClocks.relative})});return o.push(p.unsubscribe),{cleanupTasks:o,observer:a}}function b(){let t=j().Profiler;if(!t)throw new Error("RUM Profiler is not supported in this browser.");L(s).catch(v);let{cleanupTasks:o,observer:a}=q(s),p;try{p=new t({sampleInterval:r.sampleIntervalMs,maxBufferSize:Math.round(r.collectIntervalMs*1.5/r.sampleIntervalMs)})}catch(u){_.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",u);return}s={state:"running",startTime:performance.now(),profiler:p,timeoutId:D(b,r.collectIntervalMs),longTasks:[],views:[],cleanupTasks:o,observer:a},E(c),p.addEventListener("samplebufferfull",O)}async function L(t){var o,a;if(t.state!=="running")return;M((a=(o=t.observer)===null||o===void 0?void 0:o.takeRecords())!==null&&a!==void 0?a:[]),x(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",O);let{startTime:p,longTasks:u,views:w}=t,te=performance.now();await t.profiler.stop().then(R=>{let N=performance.now(),ne=u.length>0,re=N-p<r.minProfileDurationMs,oe=U(R.samples)<r.minNumberOfSamples;!ne&&(re||oe)||(K(Object.assign(R,{startTime:p,endTime:N,timeOrigin:performance.timeOrigin,longTasks:u,views:w,sampleInterval:r.sampleIntervalMs})),z(te))}).catch(v)}async function S(t){s.state==="running"&&(s.cleanupTasks.forEach(o=>o()),await L(s),s={state:t})}function E(t){s.state!=="running"||!t||s.views.push(t)}function K(t){var o;let a=(o=i.findTrackedSession())===null||o===void 0?void 0:o.id;H.sendProfile(t,e.profilingEndpointBuilder,e.applicationId,a).catch(v)}function O(){b()}function Q(t){M(t.getEntries())}function M(t){if(s.state==="running")for(let o of t)o.duration<r.sampleIntervalMs||s.longTasks.push({id:k(o),duration:o.duration,entryType:o.entryType,startTime:o.startTime})}function W(){document.visibilityState==="hidden"&&s.state==="running"?S("paused").catch(v):document.visibilityState==="visible"&&s.state==="paused"&&b()}function X(){b()}function Y(){return m?"long-animation-frame":"longtask"}function Z(){return s.state==="stopped"}function $(){return s.state==="running"}function ee(){return s.state==="paused"}return{start:y,stop:P,isStopped:Z,isRunning:$,isPaused:ee}}export{ue as DEFAULT_RUM_PROFILER_CONFIGURATION,_e as createRumProfiler};
//# sourceMappingURL=profiler-YXWQQDNE.js.map
